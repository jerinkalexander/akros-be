name: Deploy to DigitalOcean

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: Deploy to Droplet
        env:
          DROPLET_IP: ${{ secrets.DROPLET_IP }}
          DROPLET_PASSWORD: ${{ secrets.DROPLET_PASSWORD }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          # Create a script file to run on the droplet
          cat > deploy_script.sh << 'EOF'
          #!/bin/bash
          
          # Set up environment variables
          export DB_PASSWORD="$DB_PASSWORD"
          export NODE_ENV=production
          
          # Update system and install dependencies
          apt update && apt upgrade -y
          apt install -y nodejs npm mysql-server
          
          # Clone or update repository
          if [ ! -d "/root/app" ]; then
            git clone https://github.com/$GITHUB_REPOSITORY /root/app
          fi
          
          cd /root/app
          git pull origin main
          
          # Set up environment file
          echo "DB_HOST=localhost" > .env
          echo "DB_USER=appuser" >> .env
          echo "DB_PASSWORD=$DB_PASSWORD" >> .env
          echo "DB_NAME=appdb" >> .env
          echo "NODE_ENV=production" >> .env
          echo "PORT=3000" >> .env
          
          # Install dependencies
          npm install --production
          
          # Configure MySQL
          sudo mysql -e "CREATE DATABASE IF NOT EXISTS appdb;"
          sudo mysql -e "CREATE USER IF NOT EXISTS 'appuser'@'localhost' IDENTIFIED BY '$DB_PASSWORD';"
          sudo mysql -e "GRANT ALL PRIVILEGES ON appdb.* TO 'appuser'@'localhost';"
          sudo mysql -e "FLUSH PRIVILEGES;"
          
          # Install PM2 if not installed
          if ! command -v pm2 &> /dev/null; then
            npm install -g pm2
          fi
          
          # Start or restart application
          pm2 delete all || true
          pm2 start npm --name "app" -- start
          pm2 save
          pm2 startup
          
          # Set up firewall
          ufw allow OpenSSH
          ufw allow 3000
          ufw --force enable
          EOF
          
          # Copy script to droplet
          sshpass -p "$DROPLET_PASSWORD" scp -o StrictHostKeyChecking=no deploy_script.sh root@$DROPLET_IP:/root/
          
          # Run script on droplet
          sshpass -p "$DROPLET_PASSWORD" ssh -o StrictHostKeyChecking=no root@$DROPLET_IP "chmod +x /root/deploy_script.sh && /root/deploy_script.sh"
          
          # Clean up
          rm deploy_script.sh
